<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FlossCross - Free cross stitch pattern maker</title>
  <style>
    :root {
      --bg: #faf8f5;
      --card: #fff;
      --border: #e8e4de;
      --text: #2c2825;
      --muted: #6b6560;
      --accent: #c45c3e;
      --accent-hover: #a84d32;
      --slot-empty: #f0ede8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .brand {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }
    .brand h1 { font-size: 1.25rem; font-weight: 600; margin: 0; }
    .lang { font-size: 0.875rem; color: var(--muted); }
    main { padding: 1.5rem; max-width: 960px; margin: 0 auto; }
    h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 1rem;
      color: var(--text);
    }
    .slots {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    .slot {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
      min-height: 160px;
      display: flex;
      flex-direction: column;
    }
    .slot-title { font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem; }
    .slot-preview {
      flex: 1;
      background: var(--slot-empty);
      border-radius: 6px;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 0.875rem;
      min-height: 80px;
    }
    .slot-preview.has-image { padding: 4px; }
    .slot-preview img { max-width: 100%; max-height: 120px; object-fit: contain; }
    .slot-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s, border-color 0.15s;
    }
    .btn:hover { background: var(--slot-empty); border-color: #d0cbc4; }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    .modal h3 { margin: 0 0 1rem; font-size: 1.25rem; }
    .modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end; }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: #fef8f6; }
    .drop-zone input { display: none; }
    .preview-img { max-width: 100%; max-height: 200px; margin-top: 0.75rem; display: none; }
    .preview-img.show { display: block; margin: 0.75rem auto 0; }
    .view-modal .modal { max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; }
    .view-modal .modal-body { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; min-height: 200px; padding: 1rem; background: var(--slot-empty); border-radius: 8px; }
    .view-modal .pattern-display { max-width: 100%; max-height: 70vh; display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
    .view-modal .modal-actions { margin-top: 1rem; flex-shrink: 0; }
    #view-empty-msg { color: var(--muted); margin: 0; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>FlossCross</h1>
      <span class="lang">en</span>
    </div>
  </header>
  <main>
    <h2>Make your own cross stitch pattern</h2>
    <p style="color: var(--muted); margin: 0 0 1rem;">Dashboard</p>
    <div class="slots">
      <div class="slot" data-slot="1">
        <span class="slot-title">Slot 1</span>
        <div class="slot-preview" id="preview-1">Empty slot</div>
        <div class="slot-actions">
          <button type="button" class="btn">New</button>
          <button type="button" class="btn btn-primary from-image-btn" data-slot="1">From Image</button>
          <button type="button" class="btn view-pattern-btn" data-slot="1" disabled>View</button>
          <button type="button" class="btn export-svg-btn" data-slot="1" disabled>Export SVG</button>
          <button type="button" class="btn">Open FCJSON</button>
        </div>
      </div>
      <div class="slot" data-slot="2">
        <span class="slot-title">Slot 2</span>
        <div class="slot-preview" id="preview-2">Empty slot</div>
        <div class="slot-actions">
          <button type="button" class="btn">New</button>
          <button type="button" class="btn btn-primary from-image-btn" data-slot="2">From Image</button>
          <button type="button" class="btn view-pattern-btn" data-slot="2" disabled>View</button>
          <button type="button" class="btn export-svg-btn" data-slot="2" disabled>Export SVG</button>
          <button type="button" class="btn">Open FCJSON</button>
        </div>
      </div>
      <div class="slot" data-slot="3">
        <span class="slot-title">Slot 3</span>
        <div class="slot-preview" id="preview-3">Empty slot</div>
        <div class="slot-actions">
          <button type="button" class="btn">New</button>
          <button type="button" class="btn btn-primary from-image-btn" data-slot="3">From Image</button>
          <button type="button" class="btn view-pattern-btn" data-slot="3" disabled>View</button>
          <button type="button" class="btn export-svg-btn" data-slot="3" disabled>Export SVG</button>
          <button type="button" class="btn">Open FCJSON</button>
        </div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="import-modal">
    <div class="modal">
      <h3>Import from image</h3>
      <p style="color: var(--muted); font-size: 0.875rem; margin: 0 0 1rem;">Upload a photo or image to turn it into a cross stitch pattern.</p>
      <label class="drop-zone" id="drop-zone">
        <input type="file" id="image-input" accept="image/*">
        <span id="drop-text">Drop an image here or click to choose</span>
      </label>
      <img class="preview-img" id="import-preview" alt="">
      <div class="modal-actions">
        <button type="button" class="btn" id="modal-cancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="modal-import" disabled>Import</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay view-modal" id="view-modal">
    <div class="modal">
      <h3>Pattern view</h3>
      <div class="modal-body">
        <img class="pattern-display" id="pattern-display" alt="Pattern" style="display: none;">
        <p id="view-empty-msg" class="muted">No pattern loaded.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" id="view-modal-close">Close</button>
        <button type="button" class="btn btn-primary" id="view-export-svg">Export SVG</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/image-q@3/dist/umd/image-q.js"></script>
  <script src="../palette-dmc.js"></script>
  <script>
    const modal = document.getElementById('import-modal');
    const imageInput = document.getElementById('image-input');
    const dropZone = document.getElementById('drop-zone');
    const dropText = document.getElementById('drop-text');
    const importPreview = document.getElementById('import-preview');
    const modalCancel = document.getElementById('modal-cancel');
    const modalImport = document.getElementById('modal-import');
    const viewModal = document.getElementById('view-modal');
    const patternDisplay = document.getElementById('pattern-display');
    const viewEmptyMsg = document.getElementById('view-empty-msg');
    const viewModalClose = document.getElementById('view-modal-close');
    const viewExportSvg = document.getElementById('view-export-svg');
    let currentSlot = null;
    let selectedFile = null;
    const slotPatterns = {}; // slot -> { width, height, data, dataURL }

    document.querySelectorAll('.from-image-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentSlot = btn.dataset.slot;
        selectedFile = null;
        importPreview.classList.remove('show');
        importPreview.src = '';
        modalImport.disabled = true;
        dropText.textContent = 'Drop an image here or click to choose';
        modal.classList.add('open');
      });
    });

    modalCancel.addEventListener('click', () => modal.classList.remove('open'));
    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('open'); });

    dropZone.addEventListener('click', () => imageInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });
    imageInput.addEventListener('change', () => { if (imageInput.files.length) handleFile(imageInput.files[0]); });

    function handleFile(file) {
      if (!file.type.startsWith('image/')) return;
      selectedFile = file;
      const url = URL.createObjectURL(file);
      importPreview.src = url;
      importPreview.classList.add('show');
      modalImport.disabled = false;
      dropText.textContent = file.name;
    }

    const iq = () => window['image-q'];

    function buildDmcPalette() {
      if (typeof PALETTE === 'undefined') return null;
      const lib = iq();
      if (!lib || !lib.utils) return null;
      const palette = new lib.utils.Palette();
      for (const c of PALETTE) {
        const pt = lib.utils.Point.createByRGBA(c.rgb[0], c.rgb[1], c.rgb[2], 255);
        palette.add(pt);
      }
      return palette;
    }

    function quantizeToDmc(img, maxWidth) {
      const lib = iq();
      if (!lib || !lib.utils || typeof PALETTE === 'undefined') return null;
      const dmcPalette = buildDmcPalette();
      if (!dmcPalette) return null;

      const w = Math.min(img.naturalWidth, maxWidth || 400);
      const h = Math.round((img.naturalHeight / img.naturalWidth) * w);
      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const imageData = ctx.getImageData(0, 0, w, h);

      const inPoints = lib.utils.PointContainer.fromImageData(imageData);
      const outPoints = lib.applyPaletteSync(inPoints, dmcPalette, {
        colorDistanceFormula: 'cie94-textiles',
        imageQuantization: 'floyd-steinberg'
      });
      const outData = outPoints.toUint8Array();
      const outImageData = new ImageData(new Uint8ClampedArray(outData), w, h);
      ctx.putImageData(outImageData, 0, 0);
      return canvas;
    }

    function setSlotPattern(slot, canvas) {
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      slotPatterns[slot] = {
        width: w,
        height: h,
        data: new Uint8ClampedArray(imageData.data),
        dataURL: canvas.toDataURL('image/png')
      };
      document.querySelector('.view-pattern-btn[data-slot="' + slot + '"]').disabled = false;
      document.querySelector('.export-svg-btn[data-slot="' + slot + '"]').disabled = false;
    }

    modalImport.addEventListener('click', () => {
      if (!selectedFile || !currentSlot) return;
      const previewEl = document.getElementById('preview-' + currentSlot);
      previewEl.textContent = 'Quantizingâ€¦';
      previewEl.classList.add('has-image');

      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        const canvas = quantizeToDmc(img, 400);
        previewEl.textContent = '';
        if (canvas) {
          setSlotPattern(currentSlot, canvas);
          const outImg = document.createElement('img');
          outImg.src = canvas.toDataURL('image/png');
          outImg.alt = 'Pattern preview';
          previewEl.appendChild(outImg);
        } else {
          const fallback = document.createElement('img');
          fallback.src = importPreview.src;
          fallback.alt = 'Pattern preview';
          previewEl.appendChild(fallback);
        }
        URL.revokeObjectURL(importPreview.src);
        modal.classList.remove('open');
      };
      img.onerror = () => {
        previewEl.textContent = '';
        const fallback = document.createElement('img');
        fallback.src = importPreview.src;
        fallback.alt = 'Pattern preview';
        previewEl.appendChild(fallback);
        modal.classList.remove('open');
      };
      img.src = importPreview.src;
    });

    let viewSlot = null;

    document.querySelectorAll('.view-pattern-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        viewSlot = btn.dataset.slot;
        const p = slotPatterns[viewSlot];
        if (!p) return;
        patternDisplay.src = p.dataURL;
        patternDisplay.style.display = 'block';
        viewEmptyMsg.style.display = 'none';
        viewModal.classList.add('open');
      });
    });

    document.querySelectorAll('.export-svg-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const slot = btn.dataset.slot;
        const p = slotPatterns[slot];
        if (!p) return;
        exportPatternToSvg(p, 'flosscross-pattern-slot' + slot + '.svg');
      });
    });

    viewModalClose.addEventListener('click', () => viewModal.classList.remove('open'));
    viewModal.addEventListener('click', e => { if (e.target === viewModal) viewModal.classList.remove('open'); });

    viewExportSvg.addEventListener('click', () => {
      if (!viewSlot) return;
      const p = slotPatterns[viewSlot];
      if (!p) return;
      exportPatternToSvg(p, 'flosscross-pattern-slot' + viewSlot + '.svg');
    });

    function exportPatternToSvg(pattern, filename) {
      const { width: w, height: h, data } = pattern;
      const cellSize = 8;
      const svgW = w * cellSize;
      const svgH = h * cellSize;
      const rects = [];
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const i = (y * w + x) * 4;
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const a = data[i + 3];
          if (a < 128) continue;
          rects.push('<rect x="' + x * cellSize + '" y="' + y * cellSize + '" width="' + cellSize + '" height="' + cellSize + '" fill="rgb(' + r + ',' + g + ',' + b + ')"/>');
        }
      }
      const svg = '<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + svgW + ' ' + svgH + '" width="' + svgW + '" height="' + svgH + '">\n' + rects.join('\n') + '\n</svg>';
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
  </script>
</body>
</html>
